<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Форма ввода</title>
  <link href="styles.css" rel="stylesheet" type="text/css"/>
  <style>
    .error {
      border: 2px solid red;
    }
  </style>
  <!-- Подключение стилей flatpickr -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
</head>
<body>
  <form data-content-type="web_app_data" enctype="multipart/form-data">
    <div>
      <label for="totalAmount">Фамилия</label>
      <input id="totalAmount" name="totalAmount" placeholder="Фамилия" type="text"/>
    </div>
    <div>
      <label for="street">Имя</label>
      <input id="street" name="street" placeholder="Имя" type="text"/>
    </div>
    <div>
      <label for="house">Отчество</label>
      <input id="house" name="house" placeholder="Отчество" type="text"/>
    </div>
    <div>
      <label for="phone">Телефон</label>
      <input id="phone" inputmode="numeric" name="phone" placeholder="Телефон" type="text" value="+7"/>
    </div>
      <div>
      <label for="intercomCode">ИНН</label>
      <input id="intercomCode" name="intercomCode" placeholder="ИНН" type="text"/>
    </div>
    <div>
      <label for="city">Город</label>
      <select id="city" name="city">
        <option selected=""></option>
      </select>
    </div>

    <div>
      <label for="notes">Примечания</label>
      <textarea id="notes" name="notes" placeholder="Примечания"></textarea>
    </div>
    <div>
  <label for="photo">Фото</label>
  <input id="photo" name="photo" type="file"/>
</div>
    <div id="error"></div>
    <input id="agreeCheckbox" type="checkbox"/><label for="agreeCheckbox"> С оффертой ознакомлен!</label>
    <div class="button-group">
      <button disabled="disabled" id="submit" type="submit">Зарегистрироваться</button>
      <button id="reset" style="margin-left: 10px" type="reset">Отмена</button>
    </div>
  </form>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  <script>
    let tg = window.Telegram.WebApp;
    let submit = document.getElementById("submit");
    let reset = document.getElementById("reset");
    let phoneInput = document.getElementById("phone");
    let copyPhoneCheckbox = document.getElementById("copyPhoneCheckbox");
    let citySelect = document.getElementById("city");
    let districtSelect = document.getElementById("district");

    copyPhoneCheckbox.addEventListener("change", function() {
      if (copyPhoneCheckbox.checked) {
        contactNumberInput.value = phoneInput.value;
      } else {
        contactNumberInput.value = "";
      }
    });

    function loadJSONFile(file, callback) {
      var xhr = new XMLHttpRequest();
      xhr.overrideMimeType('application/json');
      xhr.open('GET', file, true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          callback(xhr.responseText);
        }
      };
      xhr.send(null);
    }

    function loadCities() {
      loadJSONFile('all_city.json', function (response) {
        var cities = JSON.parse(response);
        cities.forEach(function (city) {
          var option = document.createElement('option');
          option.value = city.city;
          option.textContent = city.city;
          citySelect.appendChild(option);
        });
      });
    }

  // Function to convert a File to base64
    function fileToBase64(file, callback) {
      const reader = new FileReader();
      reader.onload = (event) => {
        callback(event.target.result);
      };
      reader.readAsDataURL(file);
    }

    function loadDistricts() {
      citySelect.addEventListener('change', function () {
        var selectedCity = citySelect.value;
        districtSelect.innerHTML = '';
        loadJSONFile('all_city.json', function (response) {
          var cities = JSON.parse(response);
          var selectedCityData = cities.find(function (city) {
            return city.city === selectedCity;
          });
          if (selectedCityData && selectedCityData.raion) {
            selectedCityData.raion.forEach(function (raion) {
              var option = document.createElement('option');
              option.value = raion;
              option.textContent = raion;
              districtSelect.appendChild(option);
            });
          }
        });
      });
    }

    loadCities();
    loadDistricts();


  // Get tomorrow's date
  let tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  // Configure flatpickr date picker with Russian locale
  flatpickr("#workDate", {
    dateFormat: "d.m.Y",
    defaultDate: tomorrow,
    locale: "ru"
  });
  submit.addEventListener("click", (event) => {
    event.preventDefault();
    const photoInput = document.getElementById("photo");
    const selectedPhoto = photoInput.files[0];

    if (selectedPhoto) {
      fileToBase64(selectedPhoto, (base64Data) => {
        // Добавляем base64-код фото в объект data
        data.photo = base64Data;
        sendDataToTelegram(data);
      });
    } else {
      sendDataToTelegram(data);
    }
  });

    let hvsQuantity = document.getElementById("hvsQuantity");
    let gvsQuantity = document.getElementById("gvsQuantity");
    let totalAmount = document.getElementById("totalAmount");
    let phone = document.getElementById("phone");
    let contactNumber = document.getElementById("contactNumber");
    let city = document.getElementById("city");
    let district = document.getElementById("district");
    let street = document.getElementById("street");
    let house = document.getElementById("house");
    let building = document.getElementById("building");
    let apartment = document.getElementById("apartment");
    let entrance = document.getElementById("entrance");
    let floor = document.getElementById("floor");
    let intercomCode = document.getElementById("intercomCode");
    let workDate = document.getElementById("workDate");
    let workInterval = document.getElementById("workInterval");
    let notes = document.getElementById("notes");
    let error = document.getElementById("error");
    error.innerText = "";
    let invalidFields = [];


    // Проверка на наличие нецифровых символов в поле номера дома
    if (house.value.trim() === "" || /\D/.test(house.value)) {
      house.classList.add("error");
      invalidFields.push("Номер дома должен содержать только цифры");
    } else {
      house.classList.remove("error");
    }

    if (totalAmount.value.trim() === "") {
      totalAmount.classList.add("error");
      invalidFields.push("Фамилия");
    } else {
      totalAmount.classList.remove("error");
    }
    if (phone.value.trim() === "" || !/^\+7\d{10}$/.test(phone.value)) {
      phone.classList.add("error");
      invalidFields.push("Телефон");
    } else {
      phone.classList.remove("error");
    }
    if (contactNumber.value.trim() === "" || !/^\+7\d{10}$/.test(contactNumber.value)) {
      contactNumber.classList.add("error");
      invalidFields.push("Номер телефона звонящего");
    } else {
      contactNumber.classList.remove("error");
    }
    if (city.value.trim() === "") {
      city.classList.add("error");
      invalidFields.push("Город");
    } else {
      city.classList.remove("error");
    }
    if (district.value.trim() === "") {
      district.classList.add("error");
      invalidFields.push("Район");
    } else {
      district.classList.remove("error");
    }
    if (street.value.trim() === "") {
      street.classList.add("error");
      invalidFields.push("Имя");
    } else {
      street.classList.remove("error");
    }
    if (house.value.trim() === "") {
      house.classList.add("error");
      invalidFields.push("Отчество");
    } else {
      house.classList.remove("error");
    }
    if (invalidFields.length > 0) {
      error.innerText = "Пожалуйста, правильно заполните следующие поля: " + invalidFields.join(", ");
      return;
    }
    let data = {
      hvsQuantity: hvsQuantity.value,
      gvsQuantity: gvsQuantity.value,
      totalAmount: totalAmount.value,
      phone: phone.value,
      contactNumber: contactNumber.value,
      city: city.value,
      district: district.value,
      street: street.value,
      house: house.value,
      building: building.value,
      apartment: apartment.value,
      entrance: entrance.value,
      floor: floor.value,
      intercomCode: intercomCode.value,
      workDate: workDate.value,
      workInterval: workInterval.value,
      notes: notes.value
    };
    // Send data to Telegram
    tg.sendData(JSON.stringify(data));
    // Close the window
    tg.close();
  });
  reset.addEventListener("click", () => {
    // Actions when "Cancel" button is clicked
    tg.close();
  });
  document.addEventListener("DOMContentLoaded", function() {
  let inputFields = document.querySelectorAll("input, select, textarea");
  for (let i = 0; i < inputFields.length; i++) {
    let currentField = inputFields[i];
    currentField.addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        let nextFieldIndex = i + 1;
        if (nextFieldIndex < inputFields.length) {
          let nextField = inputFields[nextFieldIndex];
          nextField.focus();
        }
      }
    });
  }
});
document.addEventListener("DOMContentLoaded", function() {
  let phoneInput = document.getElementById("phone");
  let contactNumberInput = document.getElementById("contactNumber");
  phoneInput.addEventListener("focus", function() {
    if (phoneInput.value === "+7") {
      setTimeout(function() {
        phoneInput.setSelectionRange(2, 2);
      }, 0);
    }
  });
  contactNumberInput.addEventListener("focus", function() {
    if (contactNumberInput.value === "+7") {
      setTimeout(function() {
        contactNumberInput.setSelectionRange(2, 2);
      }, 0);
    }
  });
});
</script>
<div id="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
<div style="background-color: white; padding: 20px; max-width: 500px; width: 80%;">
<div id="modalContent"></div>
<p>К приходу нашего специалиста подготовьте пожалуйста документы на счетчик(и) при их наличии.
По выполнении работ специалист выдаст вам квитанцию и акт о поверке. Акт о поверке ваших счетчиков необходимо предоставить вашей управляющей компании (расчетный центр).</p>
<button onclick="document.getElementById('modal').style.display = 'none'">Вернуться назад</button>
</div>
</div>
<script>
    document.getElementById('checkButton').addEventListener('click', function() {
        var content = '';
        content += 'Общая Фамилия: ' + document.getElementById('totalAmount').value + '<br>';
        content += 'Телефон: ' + document.getElementById('phone').value + '<br>';
        content += 'Номер контакта: ' + document.getElementById('contactNumber').value + '<br>';
        content += 'Город: ' + document.getElementById('city').value + '<br>';
        content += 'Район: ' + document.getElementById('district').value + '<br>';
        content += 'Имя: ' + document.getElementById('street').value + '<br>';
        content += 'Отчество: ' + document.getElementById('house').value + '<br>';
        content += 'ИНН: ' + document.getElementById('intercomCode').value + '<br>';
        content += 'Интервал работы: ' + document.getElementById('workInterval').value + '<br>';
        content += 'Примечания: ' + document.getElementById('notes').value + '<br>';

        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modal').style.display = 'flex';
    });
</script>

<script>
    document.getElementById('agreeCheckbox').addEventListener('change', function() {
        var btn = document.querySelector('button[disabled]');
        if (this.checked) {
            btn.removeAttribute('disabled');
        } else {
            btn.setAttribute('disabled', 'disabled');
        }
    });
</script>
</body>
</html>